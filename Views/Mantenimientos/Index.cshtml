@model IEnumerable<SWebEnergia.Models.Mantenimiento>

@{
    ViewData["Title"] = "Mantenimientos";
    // Los valores vienen del controlador en ViewData: "cliente","tipo","desde","hasta","estado"
    var clienteFilter = ViewData["cliente"] as string ?? "";
    var tipoFilter = ViewData["tipo"] as string ?? "";
    var desdeFilter = ViewData["desde"] as string ?? "";
    var hastaFilter = ViewData["hasta"] as string ?? "";
    var estadoFilter = ViewData["estado"] as string ?? "";
}

<div class="card p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="fa-solid fa-tools"></i> Mantenimientos</h4>
        <a class="btn btn-success" asp-action="Create"><i class="fa-solid fa-plus"></i> Nuevo</a>
    </div>

    @* --- Código para mostrar los mensajes aquí --- *@
    @if (TempData["Ok"] != null)
    {
        <div class="alert alert-success">@TempData["Ok"]</div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @* --- Fin del código de mensajes --- *@

    <form method="get" asp-action="Index" class="row g-2 mb-3">
        <div class="col-md-3">
            <input name="cliente" value="@clienteFilter" class="form-control" placeholder="Buscar cliente" />
        </div>

        <div class="col-md-2">
            <select name="tipo" class="form-select">
                <option value="">-- Tipo (todos) --</option>

                @if (tipoFilter == "Preventivo")
                {
                    <option value="Preventivo" selected>Preventivo</option>
                }
                else
                {
                    <option value="Preventivo">Preventivo</option>
                }

                @if (tipoFilter == "Correctivo")
                {
                    <option value="Correctivo" selected>Correctivo</option>
                }
                else
                {
                    <option value="Correctivo">Correctivo</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <select name="estado" class="form-select">
                <option value="">-- Estado (todos) --</option>

                @if (estadoFilter == "Pendiente")
                {
                    <option value="Pendiente" selected>Pendiente</option>
                }
                else
                {
                    <option value="Pendiente">Pendiente</option>
                }

                @if (estadoFilter == "En Proceso")
                {
                    <option value="En Proceso" selected>En Proceso</option>
                }
                else
                {
                    <option value="En Proceso">En Proceso</option>
                }

                @if (estadoFilter == "Finalizado")
                {
                    <option value="Finalizado" selected>Finalizado</option>
                }
                else
                {
                    <option value="Finalizado">Finalizado</option>
                }
            </select>
        </div>

        <div class="col-md-2">
            <input name="desde" type="date" class="form-control" value="@desdeFilter" />
        </div>

        <div class="col-md-2">
            <input name="hasta" type="date" class="form-control" value="@hastaFilter" />
        </div>

        <div class="col-md-1 d-grid">
            <button type="submit" class="btn btn-primary"><i class="fa-solid fa-magnifying-glass"></i> Buscar</button>
        </div>

        <div class="col-md-1 d-grid">
            <a asp-action="Index" class="btn btn-outline-secondary"><i class="fa-solid fa-rotate"></i> Limpiar</a>
        </div>
    </form>

    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Fecha Programada</th>
                    <th>Fecha Fin</th>
                    <th>Estado</th>
                    <th style="width:170px" class="text-end">Acciones</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    foreach (var item in Model)
                    {
                        <tr>
                            <td>@item.Cliente?.Nombre</td>
                            <td>@item.TipoMantenimiento</td>
                            <td>@item.FechaProgramada?.ToString("dd/MM/yyyy")</td>
                            <td>@(item.FechaFin.HasValue ? item.FechaFin.Value.ToString("dd/MM/yyyy") : "-")</td>
                            <td>@item.Estado</td>
                            <td class="text-end">
                                <a class="btn btn-sm btn-outline-primary" asp-action="Edit" asp-route-id="@item.IdMantenimiento"><i class="fa-solid fa-pen"></i></a>
                                <a class="btn btn-sm btn-outline-info" asp-action="Details" asp-route-id="@item.IdMantenimiento"><i class="fa-solid fa-eye"></i></a>
                                <a class="btn btn-sm btn-outline-danger" asp-action="Delete" asp-route-id="@item.IdMantenimiento"><i class="fa-solid fa-trash"></i></a>
                                @if (item.Estado == "Finalizado")
                                {
                                    <a href="javascript:void(0);" onclick="mostrarVistaPrevia(@item.IdMantenimiento)" class="btn btn-sm btn-outline-secondary" title="Comprobante">
                                        <i class="fa-solid fa-file-invoice"></i>
                                    </a>
                                }

                              

                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="6" class="text-center">No se encontraron registros.</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Modal de Vista Previa -->
<div class="modal fade" id="modalVistaPrevia" tabindex="-1" aria-labelledby="modalVistaPreviaLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 90vw; height: 90vh;">
        <div class="modal-content" style="height: 90vh;">
            <div class="modal-header">
                <h5 class="modal-title" id="modalVistaPreviaLabel">Vista Previa del Comprobante</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-0" style="height: calc(100% - 120px);">
                <!-- Iframe para mostrar el PDF -->
                <iframe id="iframePdfPreview" style="width: 100%; height: 100%;" frameborder="0"></iframe>
            </div>
            <div class="modal-footer">
                <a id="btnDescargarPdf" href="#" class="btn btn-primary" target="_blank">
                    <i class="fa-solid fa-download"></i> Descargar PDF
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fa-solid fa-xmark"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function mostrarVistaPrevia(idMantenimiento) {
            fetch('/Mantenimientos/ObtenerComprobantePorMantenimiento/' + idMantenimiento)
                .then(async response => {
                    const contentType = response.headers.get("content-type");

                    // Si la respuesta no es exitosa (status 400 o 500)
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText);
                    }

                    // Validar que la respuesta sea JSON
                    if (contentType && contentType.includes("application/json")) {
                        return response.json();
                    } else {
                        throw new Error("La respuesta no es JSON válida.");
                    }
                })
                .then(data => {
                    if (!data || !data.success || data.idComprobante <= 0) {
                        document.getElementById('iframePdfPreview').style.display = 'none';
                        document.getElementById('btnDescargarPdf').style.display = 'none';
                        alert('Este mantenimiento aún no tiene comprobante.');
                    } else {
                        const idComprobante = data.idComprobante;

                        document.getElementById('iframePdfPreview').style.display = 'block';
                        const pdfUrl = '/Mantenimientos/ComprobantePdfConPlantilla/' + idComprobante;
                        document.getElementById('iframePdfPreview').src = pdfUrl;
                        document.getElementById('btnDescargarPdf').href = pdfUrl;
                        document.getElementById('btnDescargarPdf').style.display = 'inline-block';

                        const modal = new bootstrap.Modal(document.getElementById('modalVistaPrevia'));
                        modal.show();
                    }
                })
                .catch(error => {
                    console.error('Error al obtener el comprobante:', error);
                    alert('Error al obtener la vista previa del comprobante.');
                });
        }
    </script>
}


